---
title: "Weekly snapshot"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
source("helpers.R")
combined <- get_tidy_game_data()
options(tibble.width = Inf)
THIS_SEASON <- "Fall"
THIS_YEAR <- 2017
```

## This season
```{r}
season <- combined %>% 
    filter(Season == THIS_SEASON, Year == THIS_YEAR) 

games <- season %>% 
    group_by(Team) %>% 
    summarise(Win = sum(Outcome == "Win"), Tie = sum(Outcome == "Tie"), 
        Loss = sum(Outcome == "Loss"), Games = n()) %>% 
    arrange(desc((Win + (Tie / 2)) / Games))

scores <- season %>% 
    group_by(Team) %>% 
    summarise(ScoredPerGame = round(mean(Score), 1), 
        AllowedPerGame = round(mean(OpponentScore), 1),
        Margin = round(mean(Score - OpponentScore), 1), 
        TotalRunsScored = sum(Score), TotalRunsAllowed = sum(OpponentScore)) %>% 
    # order by games df
    arrange(desc(Margin))

print(games, n = Inf)

print(scores, n = Inf)

ggplot(scores, aes(x = AllowedPerGame, y = ScoredPerGame, color = Team)) + 
    geom_abline(slope = 1, intercept = c(0, 0)) +
    geom_point() + 
    xlim(c(0, max(scores$AllowedPerGame))) + 
    ylim(c(0, max(scores$ScoredPerGame))) 

ggplot(scores, aes(x = TotalRunsAllowed, y = TotalRunsScored, color = Team)) + 
    geom_abline(slope = 1, intercept = c(0, 0)) +
    geom_point() + 
    xlim(c(0, max(scores$TotalRunsAllowed))) + 
    ylim(c(0, max(scores$TotalRunsScored))) 
```

## All time statistics
```{r}
game_n <- combined %>% 
    select(Date, Field) %>%
    unique() %>% 
    arrange(Date, Field) %>% 
    mutate(GameN = 1:n())

highlight_teams <- combined %>% 
    filter(Season == THIS_SEASON, Year == THIS_YEAR) %>% 
    .$Opponent %>% 
    unique()

games <- combined %>% 
    merge(game_n) %>% 
    group_by(Team) %>% 
    arrange(Date) %>% 
    mutate(Record = cumsum(Outcome == "Win") / seq_along(Outcome), 
        Margin = cumsum(Score - OpponentScore) / seq_along(Outcome), 
        runfrac = cummean(Score / (Score + OpponentScore))) %>% 
    # highlight teams from this season
    mutate(Highlight = ifelse(Team %in% highlight_teams, Team, "Other")) %>% 
    mutate(Highlight = factor(Highlight, levels = c(highlight_teams, "Other"))) %>% 
    arrange(Highlight)

high <- filter(games, Highlight != "Other")
ggplot(games, mapping = aes(x = GameN, y = Record, color = Highlight)) + 
    geom_line(aes(group = Team), color = "grey") + 
    geom_line(data = high, aes(group = Team)) + 
    ggtitle("Complete record")

ggplot(games, mapping = aes(x = GameN, y = Margin, color = Highlight)) + 
    geom_line(aes(group = Team), color = "grey") + 
    geom_line(data = high, aes(group = Team)) + 
    ggtitle("Complete margin")
```